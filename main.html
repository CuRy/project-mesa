<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <style>
#hud {
    line-height:30px;
    background-color:#eeeeee;
    height:300px;
    width:100px;
    float:left;
    padding:5px; 
}
</style>
  <body style="width:1920; height:1080">
    <canvas style="float:left;" id="myCanvas" width="1920" height="1060"></canvas>
    <div id="hud" width="150" height="300">
    	p1<input type="number" name="param1"  id="param1" min="1" max="12">
    	p2<input name="param2"  id="param2"  >
    	code<input name="code"  id="code"  >
    	<button type="button" onclick="inp()">Action!</button>
    	

    </div>

   <script src="jquery211.js"></script>
    <script>


    	//================  INIT  ======================
		
		var players = 2;
		var castleHP=50;
		var tmpCastleHP=castleHP;
		var lanes = 8;
		var currentPlayer=0;
		//var monsters=1;
		var turn=0;
		var player=[];
		var charHeight=56;
		var charWidth=28;
		var movSteps=2; //For movement animation
		var sizeSteps=2;	//For scale animation
		var laneLvl =[];
		var monsterInfo=[];
		var monster=[];
		var monsters=[];
		var laneSize=12;
		var summonTurns=3;
		var monsterMoveTurns=2;
		var energy=0;
		var defInfo=[];
		var vitInfo=[];
		var atkInfo=[];
		var enrInfo=[];


		var input=false;


		//HUD
		var boardW=1620;
		var boardH=1060;
		var infoBoxW=112;
		var infoBoxH=168;
		var battleback = {w:640, h:320, tmpw:0, tmph:0};
		var battlePlayer={w:0, h:0, tmph:0,tmpw:0, x:659, y:560};
		var battleMonster={id:0, w:0, h:0, tmph:0,tmpw:0,x:920, y:560};
		var atributeHoffset=50;
		var atributeVoffset=70;
		var monsterBattleIcon={h:48, w:48};

		var animInfo = [];
		var dmgText ={ttl:0,x:0,y:0, text:""};
		var flashVal=30;
		animInfo["sword"] = [];

		animInfo["sword"][0]={x:-100, y:-100, w:0,h:0, sizeStep:48, movStep:16};
		animInfo["sword"][1]={x:0, y:0, w:192,h:192, sizeStep:48, movStep:16};
		animInfo["sword"][2]={x:100, y:100, w:0,h:0, sizeStep:48, movStep:16};

		var currentAnimation={active:false, type:"", stage:0, x:0, y:0, tmpx:0, tmpy:0, w:0, h:0, tmpw:0,tmph:0, basex:0, basey:0};

		var phases = {
			playerChoose:"playerChoose",
			intro:"intro",
			summon:"summon",
			monsterAdvance:"minionAdvance",
			playerEnergy:"playerEnergy",
			playerActions:"playerActions", 
			battle:"battle",
			playerAtk:"playerAtk",
			enemyAtk:"enemyAtk"
		}

		

		board = [];

		board["center"] = {x:827, y:450};
		board["0.13"] = {x:89, y:63};
		board["1.13"] = {x:1177, y:43};
		board["2.13"] = {x:1556, y:203};
		board["3.13"] = {x:1557, y:870};
		board["4.13"] = {x:1198, y:1028};
		board["5.13"] = {x:327, y:1019};
		board["6.13"] = {x:49, y:818};
		board["7.13"] = {x:57, y:292};


		board["0.0"] = {x:766, y:366} ;
		board["0.1"] = {x:794, y:345} ;
		board["0.2"] = {x:794, y:297} ;
		board["0.3"] = {x:729, y:264} ;
		board["0.4"] = {x:663, y:250} ;
		board["0.5"] = {x:633, y:204} ;
		board["0.6"] = {x:583, y:187} ;
		board["0.7"] = {x:520, y:155} ;
		board["0.8"] = {x:453, y:137} ;
		board["0.9"] = {x:389, y:136} ;
		board["0.10"] = {x:324, y:123} ;
		board["0.11"] = {x:257, y:92} ;
		board["0.12"] = {x:211, y:59} ;

		board["1.0"] = {x:894, y:375};
		board["1.1"] = {x:892, y:326};
		board["1.2"] = {x:892, y:280};
		board["1.3"] = {x:943, y:255};
		board["1.4"] = {x:1007, y:256};
		board["1.5"] = {x:1069, y:254};
		board["1.6"] = {x:1134, y:238};
		board["1.7"] = {x:1201, y:239};
		board["1.8"] = {x:1231, y:193};
		board["1.9"] = {x:1216, y:147};
		board["1.10"] = {x:1166, y:129};
		board["1.11"] = {x:1117, y:114};
		board["1.12"] = {x:1067, y:98} ;

		board["2.0"] = {x:970, y:481};
		board["2.1"] = {x:1023, y:478};
		board["2.2"] = {x:1073, y:480};
		board["2.3"] = {x:1122, y:480};
		board["2.4"] = {x:1171, y:479};
		board["2.5"] = {x:1203, y:432};
		board["2.6"] = {x:1267, y:416};
		board["2.7"] = {x:1335, y:416};
		board["2.8"] = {x:1332, y:352};
		board["2.9"] = {x:1351, y:290};
		board["2.10"] = {x:1365, y:227};
		board["2.11"] = {x:1414, y:196};
		board["2.12"] = {x:1480, y:194};

		board["3.0"] = {x:940, y:535};
		board["3.1"] = {x:990, y:549};
		board["3.2"] = {x:1041, y:581};
		board["3.3"] = {x:1090, y:595};
		board["3.4"] = {x:1155, y:627};
		board["3.5"] = {x:1220, y:627};
		board["3.6"] = {x:1283, y:627};
		board["3.7"] = {x:1312, y:671};
		board["3.8"] = {x:1347, y:715};
		board["3.9"] = {x:1379, y:766};
		board["3.10"] = {x:1380, y:827};
		board["3.11"] = {x:1428, y:841};
		board["3.12"] = {x:1478, y:856};

		board["4.0"] = {x:866, y:573};
		board["4.1"] = {x:877, y:626};
		board["4.2"] = {x:893, y:674};
		board["4.3"] = {x:892, y:720};
		board["4.4"] = {x:926, y:751};
		board["4.5"] = {x:973, y:783};
		board["4.6"] = {x:1038, y:800};
		board["4.7"] = {x:1092, y:800};
		board["4.8"] = {x:1154, y:799};
		board["4.9"] = {x:1220, y:814};
		board["4.10"] = {x:1253, y:862};
		board["4.11"] = {x:1268, y:924};
		board["4.12"] = {x:1266, y:987};

		board["5.0"] = {x:792, y:591} ;
		board["5.1"] = {x:794, y:643} ;
		board["5.2"] = {x:796, y:704} ;
		board["5.3"] = {x:813, y:766} ;
		board["5.4"] = {x:811, y:831} ;
		board["5.5"] = {x:780, y:880} ;
		board["5.6"] = {x:697, y:881} ;
		board["5.7"] = {x:632, y:846} ;
		board["5.8"] = {x:566, y:817} ;
		board["5.9"] = {x:502, y:833} ;
		board["5.10"] = {x:440, y:848} ;
		board["5.11"] = {x:373, y:896} ;
		board["5.12"] = {x:323, y:944} ;
		
		board["6.0"] = {x:686, y:501};
		board["6.1"] = {x:651, y:502};
		board["6.2"] = {x:584, y:502};
		board["6.3"] = {x:536, y:534};
		board["6.4"] = {x:536, y:598};
		board["6.5"] = {x:471, y:626};
		board["6.6"] = {x:405, y:628};
		board["6.7"] = {x:357, y:614};
		board["6.8"] = {x:291, y:629};
		board["6.9"] = {x:244, y:663};
		board["6.10"] = {x:192, y:689};
		board["6.11"] = {x:177, y:756};
		board["6.12"] = {x:127, y:786};

		board["7.0"] = {x:678, y:445};
		board["7.1"] = {x:617, y:440};
		board["7.2"] = {x:567, y:424};
		board["7.3"] = {x:488, y:424};
		board["7.4"] = {x:423, y:442};
		board["7.5"] = {x:357, y:441};
		board["7.6"] = {x:357, y:380};
		board["7.7"] = {x:373, y:331};
		board["7.8"] = {x:390, y:285};
		board["7.9"] = {x:374, y:223};
		board["7.10"] = {x:307, y:222};
		board["7.11"] = {x:225, y:206};
		board["7.12"] = {x:163, y:222};

		
		
		monsterInfo[0]={lvl:1, vit:4, atk:4, def:0,w:50,h:50};
		monsterInfo[25]={lvl:25, vit:50, atk:12, def:3,w:135,h:101};
		
		var atkMax=5;
		var vitMax=6;
		var defMax=5;
		var enrMax=5;


		atkInfo[0]={cost:0, val:4, w:56, h:84};
		atkInfo[1]={cost:40, val:6, w:56, h:84};
		atkInfo[2]={cost:60, val:8, w:56, h:84};
		atkInfo[3]={cost:100, val:10, w:56, h:84};
		atkInfo[4]={cost:160, val:12, w:56, h:84};

		vitInfo[0]={cost:0, val:20, w:56, h:56};
		vitInfo[1]={cost:20, val:24, w:56, h:56};
		vitInfo[2]={cost:30, val:28, w:56, h:56};
		vitInfo[3]={cost:50, val:32, w:56, h:56};
		vitInfo[4]={cost:80, val:36, w:56, h:56};
		vitInfo[5]={cost:120, val:40, w:56, h:56};

		defInfo[0]={cost:0, val:0, w:56, h:84};
		defInfo[1]={cost:30, val:1, w:56, h:84};
		defInfo[2]={cost:50, val:2, w:56, h:84};
		defInfo[3]={cost:90, val:3, w:56, h:84};
		defInfo[4]={cost:150, val:4, w:56, h:84};
		defInfo[5]={cost:230, val:5, w:56, h:84};

		enrInfo[0]={cost:0, val:4, w:56, h:56};
		enrInfo[1]={cost:0, val:6, w:56, h:56};
		enrInfo[2]={cost:0, val:8, w:56, h:56};
		enrInfo[3]={cost:0, val:10, w:56, h:56};
		enrInfo[4]={cost:0, val:12, w:56, h:56};


		for (var i=0;i<lanes;i++)
		{
			laneLvl[i] = 0;

		}
		
		var canvas = document.getElementById('myCanvas');
			var context = canvas.getContext('2d');
			var boardImg = new Image();
			var charImg = new Image();
			var battlebackImg = new Image();
			var images = {};
			var monsterImg = {};
			
			var defImg = {};
			var atkImg = {};
			var vitImg = {};
			var enrImg = {};
			var animImg=[];
			context.imageSmoothingEnabled = true;
			
		function loadImages(sources) {
        for(var src in sources) {
          images[src] = new Image();
          images[src].src = sources[src];
          }

          monsterImg[0]=new Image();
          monsterImg[0].src = "monster/monster1.png";

          monsterImg[25]=new Image();
          monsterImg[25].src = "monster/monster25.png";

          battlebackImg.src = "battleback.jpg";

          monsterAtkImg = new Image();
          monsterDefImg = new Image();
          monsterHpImg = new Image();
          monsterAtkImg.src = "items/atkIcon.png";
          monsterDefImg.src = "items/defIcon.png";
          monsterHpImg.src = "items/hpIcon.png";

          for (var d in defInfo)
          {
          	defImg[d]=new Image();
          	defImg[d].src= "items/armor"+d+".gif";
          }
          for (var d in atkInfo)
          {
          	atkImg[d]=new Image();
          	atkImg[d].src= "items/sword"+d+".gif";
          }
          for (var d in vitInfo)
          {
          	vitImg[d]=new Image();
          	vitImg[d].src= "items/helm"+d+".gif";
          }
          for (var d in enrInfo)
          {
          	enrImg[d]=new Image();
          	enrImg[d].src= "items/boots"+d+".gif";
          }

      
          animImg["sword"]=new Image();
          animImg["sword"].src="anim/sword.png";
        }
      
    

      var sources = {
        boardImg: "board.png",
        charImg: "chars/char1.png",
        monster25Img: "monster/monster25.png",
        monster1Img: "monster/monster1.png"
      };

      loadImages(sources);
	  setInterval(function(){render()}, 30);
	  setInterval(function(){processAction()}, 100);
	  

	  //================  ACTION  ======================

	  var phaseControl=0;
	  var phaseComplete=[0, 0, 0, 0, 0];
	  var phaseValue=[0, 0, 0, 0, 0];
	  var waitLeft=0;
	
	  var action = {
	  	code:"",
	  	param1:"",
	  	param2:""
	  };

		switchPhase(phases.intro);

	  function inp(){
	  	input=true; 
	  	console.log("user input");
	  }

	  function switchPhase(toPhase)
	  {
	  	if (toPhase==phases.intro)
	  	{
	  		phaseControl=0;
	  		phaseComplete[0]=lanes;
	  		phaseComplete[1]=players;
	  		phaseValue[0]=0;
	  		phaseValue[0]=0;

	  		phase=phases.intro;
	  	}

	  	if (toPhase==phases.summon)
	  	{
	  		phase=phases.summon;
	  	}

		if (toPhase==phases.monsterAdvance)
	  	{
	  		phaseComplete[0]=0;
		  	phaseValue[0]=0;

	  		for (m in monsters)
	  		{
	  			
	  			if (monsters[m].lvl < 25 && monsters[m].alive==true)
	  			{
	  				monsters[m].toAdvance--;
	  				if (monsters[m].toAdvance==0)
	  					phaseComplete[0]++;
	  			}

	  		}

	  		phase=phases.monsterAdvance;
	  	}

	  	 if (toPhase==phases.playerEnergy)
	  	{
	  		phase=phases.playerEnergy;
	  	}

	  	if (toPhase==phases.playerActions)
	  	{
	  		input=false;
	  		phase=phases.playerActions;
	  		
	  	}

	  	if (toPhase==phases.battle)
	  	{
	  		input=false;
	  		
	  		battlePlayer.w=charWidth*2;
	  		battlePlayer.h=charHeight*2;
	  		
	  		battleMonster.w=monsterInfo[monsters[battleMonster.id].lvl].w*2;
	  		battleMonster.h=monsterInfo[monsters[battleMonster.id].lvl].h*2;

	  		//console.log("monster lvl "+battleMonster.w);

	  		battlePlayer.tmpw=0;
	  		battlePlayer.tmph=0;
	  		battleMonster.tmpw=0;
	  		battleMonster.tmph=0;

	  		flashVal=30;
	  		phase=phases.battle;
	  		
	  	}

	  	console.log("Phase is: "+phase);
	  }

	  function wait(time) {
	  	waitLeft+=time;
	  }


	  function processAction()
	  {
	  	if (waitLeft>0){
	  		waitLeft--;
	  		return;
	  	}

	  	for (m in monsters)
	  	{
	  		var mon=monsters[m];
	  		(mon.hp<mon.tmphp)?mon.tmphp--:0;
	  	}

	  	for (p=0;p<player.length;p++)
	  	{
	  		var pl=player[p];
	  		(pl.hp<pl.tmphp)?pl.tmphp--:0;
	  		(pl.hp>pl.tmphp)?pl.tmphp++:0;	  		
	  	}
	  	
	  	//================   PHASE INTRO ======================
	  	if (phase==phases.intro)
	  	{
	  		if (phaseControl==0)
	  		{
	  			if (phaseValue[0]<phaseComplete[0])
	  			{
	  				spawnMonster(phaseValue[0], 25, true);
	  				phaseValue[0]++
	  			}
	  			else
	  				phaseControl++;

	  			
	  		}
	  		if (phaseControl==1)
	  		{
	  			if (phaseValue[1]<phaseComplete[1])
	  			{
					player[phaseValue[1]] = {
						lane:phaseValue[1], 
						box:0, 
						x:board["center"].x, 
						y:board["center"].y, 
						tmpx:board["center"].x, 
						tmpy:board["center"].y, 
						vitLvl:0, 
						hp:vitInfo[0].val, 
						tmphp:vitInfo[0].val, 
						atkLvl:0, 
						defLvl:0, 
						enrLvl:0, 
						tmpgold: 0, 
						gold:0, 
						turnsToLive:0,
						alive:true
					};
					phaseValue[1]++;
	  			}
	  			else
	  			phaseControl++
	  		}
	  		wait(8);
	  		if (phaseControl==2)
	  			switchPhase(phases.monsterAdvance);
	  	}

		//================  PHASE SUMMON  ======================
	  	if (phase==phases.summon)
	  	{
	  		//var lane = $("#param1").val();
	  		//console.log("spawnMonster on lane "+ lane);
	  		var spawnLane=Math.floor((Math.random() * lanes));
	  		spawnMonster(spawnLane, laneLvl[spawnLane]);
	  		laneLvl[spawnLane]++;
	  		switchPhase(phases.playerEnergy);
	  	}

		//================  PHASE MONSTER ADVANCE ======================
	  	if (phase==phases.monsterAdvance)
	  	{
	  		for (m in monsters)
	  		{
	  			
	  			if (monsters[m].lvl < 25 && monsters[m].alive==true)
	  			{
	  				if (monsters[m].toAdvance==0)
	  				{
	  					console.log("Monster lvl "+monsters[m].lvl+" in lane "+ monsters[m].lane + " advances");
		  				if (monsters[m].box>0)
		  					monsters[m].box--;
		  				else
		  					attackCastle(monsters[m].lvl);

		  				monsters[m].toAdvance=monsterMoveTurns;
		  				phaseValue[0]++;
	  				}


	  			}


	  		}
	  		if (phaseValue[0]==phaseComplete[0])
	  		switchPhase(phases.summon);

	  	}

		//================  PHASE PLAYER ENERGY ======================
		if (phase==phases.playerEnergy && input==true)
		{
			energy=$("#param1").val();
			switchPhase(phases.playerActions);
		}

		//================  PHASE PLAYER ACTIONS ======================
		if (phase==phases.playerActions && input==true)
		{
			aCode=$("#code").val();
			aP1=$("#param1").val();
			aP2=$("#param2").val();
			executeAction(aCode, aP1, aP2);
			getPossibleActions();
			input=false;
		}

		if (phase==phases.battle && input==true)
		{
			aCode=$("#code").val();
			aP1=$("#param1").val();
			aP2=$("#param2").val();
			executeAction(aCode, aP1, aP2);
			input=false;
		}

	  }

	  

	  //================  RENDER  ======================
	 
		function render()
		{
			
			
			//console.log("Rendering");
			
			context.drawImage(images.boardImg, 0, 0, 1620, 1060);
			drawPlayers();
			drawMonsters();
			
			drawHUD();
			drawAnimation();
		}

		function drawPlayers()
		{
			
			
			//console.log(boardpos);
			for (var i=0;i<players;i++)
			{
				if (typeof player[i] !== 'undefined')
				{
				player[i].x=boardX(player[i].lane, player[i].box);
				player[i].y=boardY(player[i].lane, player[i].box);
				(player[i].tmpx-player[i].x<movSteps)?player[i].tmpx+=movSteps:0;
				(player[i].tmpx-player[i].x>movSteps)?player[i].tmpx-=movSteps:0;
				(player[i].tmpy-player[i].y<movSteps)?player[i].tmpy+=movSteps:0;
				(player[i].tmpy-player[i].y>movSteps)?player[i].tmpy-=movSteps:0;
				
				context.drawImage(images.charImg, player[i].tmpx-(charWidth/2), player[i].tmpy-(charHeight/2), charWidth, charHeight);
				}
			}

		}
		
      	function drawMonsters()
      	{

			
			for (var i=0;i<monsters.length;i++)
			{
				var mons = monsters[i];
				//console.log("monster lane: "+mons.lane);
				mons.x = boardX(mons.lane, mons.box);

				mons.y = boardY(mons.lane, mons.box);

				var lvl =mons.lvl;
				if (mons.alive)
				{
				(mons.tmpw - monsterInfo[lvl].w<sizeSteps) ? mons.tmpw+=sizeSteps : 0;
				(mons.tmph - monsterInfo[lvl].h<sizeSteps) ? mons.tmph+=sizeSteps : 0;

				(mons.tmpx - mons.x<movSteps) ? mons.tmpx+=movSteps : 0;
				(mons.tmpy - mons.y<movSteps) ? mons.tmpy+=movSteps : 0;
				(mons.tmpx - mons.x>movSteps) ? mons.tmpx-=movSteps : 0;
				(mons.tmpy - mons.y>movSteps) ? mons.tmpy-=movSteps : 0;


				}
				if (!mons.alive)
				{ 
					(mons.tmpw >0) ? mons.tmpw-=sizeSteps : 0;
					(mons.tmph >0) ? mons.tmph-=sizeSteps : 0;
				}
				context.drawImage(monsterImg[mons.lvl], mons.tmpx-(mons.tmpw/2), mons.tmpy-(mons.tmph/2), mons.tmpw, mons.tmph);
			}
      	}

      	function drawHUD()
      	{
      		context.fillStyle = "#333333";
      		context.fillRect(boardW, 0, infoBoxW, infoBoxH);

      		context.drawImage(vitImg[player[0].vitLvl], boardW, 0, infoBoxW/2, 56);
      		context.drawImage(defImg[player[0].defLvl], boardW+56, 0, infoBoxW/2, 84);
      		context.drawImage(atkImg[player[0].atkLvl], boardW, 56, infoBoxW/2, 84);
      		context.drawImage(enrImg[player[0].enrLvl], boardW+56, 84, infoBoxW/2, 56);



      		wset=false;
      		hset=false;
      		if (phase==phases.battle)
      		{
      			(battleback.tmpw<battleback.w) ? battleback.tmpw+=sizeSteps * 15:wset=true;
      			(battleback.tmph<battleback.h) ? battleback.tmph+=sizeSteps * 15:hset=true;

      			if (wset && hset)
      			{

      				(battlePlayer.tmpw<battlePlayer.w) ? battlePlayer.tmpw+=sizeSteps*3:0;
      				(battlePlayer.tmph<battlePlayer.h) ? battlePlayer.tmph+=sizeSteps*3:0;

      				(battleMonster.tmpw<battleMonster.w) ? battleMonster.tmpw+=sizeSteps*3:0;
      				(battleMonster.tmph<battleMonster.h) ? battleMonster.tmph+=sizeSteps*3:0;
      				//console.log(battleMonster.tmpw+"  "+battleMonster.w);
      				//console.log(battleMonster.tmph+"  "+battleMonster.h);
      			}


      			
      		}
      		if (phase!=phases.battle)
      		{
      			(battleback.tmpw>0) ? battleback.tmpw-=sizeSteps * 10:0;
      			(battleback.tmph>0) ? battleback.tmph-=sizeSteps * 10:0;
      		}

      		context.drawImage(battlebackImg, (boardW/2)-(battleback.tmpw/2), (boardH/2)-(battleback.tmph/2), battleback.tmpw,battleback.tmph);
      		if (wset && hset)
      		{
      			var mons = monsters[battleMonster.id];

      			if (player[currentPlayer].hp>0)      			{
      				context.drawImage(images.charImg, battlePlayer.x-(battlePlayer.tmpw/2), battlePlayer.y-(battlePlayer.tmph/2), battlePlayer.tmpw,battlePlayer.tmph);
      			} else{
 
      				if (flashVal%2==1)
      				{
      					context.drawImage(images.charImg, battlePlayer.x-(battlePlayer.tmpw/2), battlePlayer.y-(battlePlayer.tmph/2), battlePlayer.tmpw,battlePlayer.tmph);      					
      				}
      				if (flashVal>0) flashVal--;
      					else{ 
      						switchPhase(phases.playerActions);
      						wait(10);
      					}
      			}

      			if (monsters[battleMonster.id].hp>0)
      			{
      				context.drawImage(monsterImg[mons.lvl], battleMonster.x-(battleMonster.tmpw/2), battleMonster.y-(battleMonster.tmph/2), battleMonster.tmpw,battleMonster.tmph);
      			}else{
      				if (flashVal%2==1)
      				{
      					context.drawImage(monsterImg[mons.lvl], battleMonster.x-(battleMonster.tmpw/2), battleMonster.y-(battleMonster.tmph/2), battleMonster.tmpw,battleMonster.tmph);
      				}
      				if (flashVal>0) flashVal--;
      				else {
      					switchPhase(phases.playerActions);
      					wait(10);
      				}
      			}
				
				context.fillStyle = 'black';
				var atklvl =player[currentPlayer].atkLvl;
				var deflvl =player[currentPlayer].defLvl;
				var vitlvl =player[currentPlayer].vitLvl;

				var atkIconX = (boardW/2)-(battleback.w/2)+atributeHoffset-(atkInfo[atklvl].w/2);
				var atkIconY = (boardH/2)+0-(atkInfo[atklvl].h/2);
				context.drawImage(atkImg[atklvl], atkIconX, atkIconY, atkInfo[atklvl].w,atkInfo[atklvl].h);

				var vitIconX = (boardW/2)-(battleback.w/2)+atributeHoffset-(atkInfo[atklvl].w/2);
				var vitIconY = (boardH/2)-atributeVoffset-(atkInfo[atklvl].h/2);
				context.drawImage(vitImg[atklvl], vitIconX, vitIconY, vitInfo[vitlvl].w,vitInfo[vitlvl].h);

				var defIconX = (boardW/2)-(battleback.w/2)+atributeHoffset-(defInfo[deflvl].w/2);
				var defIconY = (boardH/2)+atributeVoffset-(defInfo[deflvl].h/2);
				context.drawImage(defImg[deflvl], defIconX, defIconY+28, defInfo[deflvl].w,defInfo[deflvl].h);

				var textOffset=30
				context.font="50px Aharoni";
				context.fillText(atkInfo[player[currentPlayer].atkLvl].val,atkIconX+textOffset+atkInfo[atklvl].w/2, atkIconY+atkInfo[atklvl].h/2);

				context.fillText(player[currentPlayer].tmphp,vitIconX+textOffset+vitInfo[vitlvl].w/2, vitIconY+vitInfo[vitlvl].h/2);

				context.fillText(defInfo[player[currentPlayer].defLvl].val,defIconX+textOffset+defInfo[deflvl].w/2, defIconY+28+defInfo[deflvl].h/2);
				//-------

				var atkIconX = (boardW/2)+(battleback.w/2)-atributeHoffset-(monsterBattleIcon.w/2);
				var atkIconY = (boardH/2)+0-(monsterBattleIcon.h/2);
				context.drawImage(monsterAtkImg, atkIconX, atkIconY, monsterBattleIcon.w, monsterBattleIcon.h);

				var vitIconX = (boardW/2)+(battleback.w/2)-atributeHoffset-(monsterBattleIcon.w/2);
				var vitIconY = (boardH/2)-atributeVoffset-(monsterBattleIcon.h/2);
				context.drawImage(monsterHpImg, vitIconX, vitIconY, monsterBattleIcon.w,monsterBattleIcon.h);

				var defIconX = (boardW/2)+(battleback.w/2)-atributeHoffset-(monsterBattleIcon.w/2);
				var defIconY = (boardH/2)+atributeVoffset-(monsterBattleIcon.h/2);
				context.drawImage(monsterDefImg, defIconX, defIconY, monsterBattleIcon.w,monsterBattleIcon.h);
				
				context.fillText(monsters[battleMonster.id].atk,atkIconX-textOffset*2+monsterBattleIcon.w/2, atkIconY+monsterBattleIcon.h/2+10);

				context.fillText(monsters[battleMonster.id].tmphp,vitIconX-textOffset*2+monsterBattleIcon.w/2, vitIconY+monsterBattleIcon.h/2+10);

				context.fillText(monsters[battleMonster.id].def,defIconX-textOffset*2+monsterBattleIcon.w/2, defIconY+monsterBattleIcon.h/2+10);

				if (dmgText.ttl>0)
				{
					context.fillStyle = 'red';
					context.fillText(dmgText.text,dmgText.x, dmgText.y);
					dmgText.ttl--;
				}



      		}
      		//context.drawImage(battlebackImg, 100, 100, 100,100);
      	}

      	function drawAnimation()
      	{

      		if (currentAnimation.active)
      		{
      			var movStep= animInfo[currentAnimation.type][currentAnimation.stage].movStep;
      			var sizeStep= animInfo[currentAnimation.type][currentAnimation.stage].sizeStep;
      			if (animInfo[currentAnimation.type][currentAnimation.stage].x-animInfo[currentAnimation.type][currentAnimation.stage-1].x > 0)
      				(currentAnimation.x -currentAnimation.tmpx > movStep) ? currentAnimation.tmpx+=movStep : currentAnimation.tmpx=currentAnimation.x;

				if (animInfo[currentAnimation.type][currentAnimation.stage].y-animInfo[currentAnimation.type][currentAnimation.stage-1].y > 0)
				(currentAnimation.y - currentAnimation.tmpy> movStep) ? currentAnimation.tmpy+=movStep : currentAnimation.tmpy=currentAnimation.y;

				if (animInfo[currentAnimation.type][currentAnimation.stage].x-animInfo[currentAnimation.type][currentAnimation.stage-1].x < 0)
				(currentAnimation.tmpx - currentAnimation.x>movStep) ? currentAnimation.tmpx-=movStep :0;

				if (animInfo[currentAnimation.type][currentAnimation.stage].y-animInfo[currentAnimation.type][currentAnimation.stage-1].y < 0)
				(currentAnimation.tmpy - currentAnimation.y>movStep) ? currentAnimation.tmpy-=movStep :0;

				if (animInfo[currentAnimation.type][currentAnimation.stage].w-animInfo[currentAnimation.type][currentAnimation.stage-1].w > 0)
				(currentAnimation.w-currentAnimation.tmpw > movStep) ? currentAnimation.tmpw+=sizeStep :currentAnimation.tmpw=currentAnimation.w;;

				if (animInfo[currentAnimation.type][currentAnimation.stage].h-animInfo[currentAnimation.type][currentAnimation.stage-1].h > 0)
				(currentAnimation.h - currentAnimation.tmph >movStep) ? currentAnimation.tmph+=sizeStep :currentAnimation.tmph=currentAnimation.h;;

				if (animInfo[currentAnimation.type][currentAnimation.stage].w-animInfo[currentAnimation.type][currentAnimation.stage-1].w < 0)
				(currentAnimation.tmpw - currentAnimation.w>movStep) ? currentAnimation.tmpw-=sizeStep :currentAnimation.tmpw=currentAnimation.w;;

				if (animInfo[currentAnimation.type][currentAnimation.stage].h-animInfo[currentAnimation.type][currentAnimation.stage-1].h < 0)
				(currentAnimation.tmph - currentAnimation.h>movStep) ? currentAnimation.tmph-=sizeStep :currentAnimation.tmph=currentAnimation.h; ;

				if (currentAnimation.tmpx==currentAnimation.x && 
					currentAnimation.tmpy== currentAnimation.y && 
					currentAnimation.tmpw== currentAnimation.w &&
					currentAnimation.tmph==currentAnimation.h)
				{
					if (currentAnimation.stage<animInfo[currentAnimation.type].length-1)
					{
						currentAnimation.stage++;
	  					currentAnimation.x=animInfo[currentAnimation.type][currentAnimation.stage].x;
	  					currentAnimation.y=animInfo[currentAnimation.type][currentAnimation.stage].y;
	  					currentAnimation.w=animInfo[currentAnimation.type][currentAnimation.stage].w;
	  					currentAnimation.h=animInfo[currentAnimation.type][currentAnimation.stage].h;
					}
					else
						currentAnimation.active=false;
				}


				console.log("Animating "+currentAnimation.tmpw+" "+currentAnimation.w+" -- "+currentAnimation.tmph+" "+currentAnimation.h +"  "+movStep);
				context.drawImage(animImg[currentAnimation.type], currentAnimation.basex+ currentAnimation.tmpx-(currentAnimation.tmpw/2), currentAnimation.basey+ currentAnimation.tmpy-(currentAnimation.tmph/2), currentAnimation.tmpw,currentAnimation.tmph);
      		}
      	}



      	//================  AUX FUNCTIONS  ======================

      	function boardX(lane, box)
      	{
			var boardpos=""+lane+"."+box;
			//console.log(boardpos);
			return board[boardpos].x;
      	}

      	function boardY(lane, box)
      	{
			var boardpos=""+lane+"."+box;
			return board[boardpos].y;
      	}
	  
	  function startAnimation(anim, x, y)
	  {
	  	currentAnimation.active=true;
	  	currentAnimation.type=anim;
	  	currentAnimation.tmpx=animInfo[anim][0].x;
	  	currentAnimation.tmpy=animInfo[anim][0].y;
	  	currentAnimation.x=animInfo[anim][1].x;
	  	currentAnimation.y=animInfo[anim][1].y;

	  	currentAnimation.tmpw=animInfo[anim][0].w;
	  	currentAnimation.tmph=animInfo[anim][0].h;
	  	currentAnimation.w=animInfo[anim][1].w;
	  	currentAnimation.h=animInfo[anim][1].h;

	  	currentAnimation.basex=x;
	  	currentAnimation.basey=y;

	  	currentAnimation.stage=1;
	  }
	  function spawnMonster(lane, lvl, boss)
	  {
	  	/*monster[lane][lvl].alive=1;
	  	monster[lane][lvl].tmpx =  board[""+lane+".13"].x;
	  	monster[lane][lvl].tmpy =  board[""+lane+".13"].y;
	  	*/
	  	console.log("Spawning lvl "+lvl+" monster at lane "+lane);
	  	var box = (boss==true)?13:laneSize;

	  	monsters.push({
	  		lvl:lvl, 
	  		hp:monsterInfo[lvl].vit, 
	  		tmphp:monsterInfo[lvl].vit, 
	  		alive:true,
	  		lane:lane, 
	  		box:box, 
	  		def:monsterInfo[lvl].def, 
	  		tmpx:boardX(lane,13), 
	  		tmpy:boardY(lane, 13), 
	  		x:boardX(lane, box), 
	  		y:boardY(lane, box),
	  		atk:monsterInfo[lvl].atk, 
	  		tmpw:0, 
	  		tmph:0, 
	  		toAdvance:monsterMoveTurns
	  	});
	  }


	  function attackCastle(monsterLvl)
	  {
	  	var atk = monsterInfo[monsterLvl].atk;
	  	var dmg = Math.floor((Math.random() * atk) + 1);
	  	castleHP-=dmg;
	  }

	  function getPossibleActions()
	  {
	  	var actionList=[];
	  	var currentBox = player[currentPlayer].box;
	  	var currentLane = player[currentPlayer].lane;

	  	//battle
	  	if (phase==phases.battle){
	  		actionList.push({code:"atk", param1:battleMonster.id, param2:0});
	  		actionList.push({code:"dmg", param1:battleMonster.id, param2:0});
	  	}

	  	//move
	  	if (currentBox>0)
	  		actionList.push({code:"mov", param1:currentLane, param2:currentBox-1});

	  	if (currentBox<laneSize)
	  		actionList.push({code:"mov", param1:currentLane, param2:(currentBox-0+1)});

	  	if (currentBox==0)
	  	{
	  		for (var l=0;l<lanes;l++)
	  			actionList.push({code:"mov", param1:l, param2:1});
	  	}
	  	
	  	//atack
	  	for (m in monsters)
	  	{
	  		if (monsters[m].alive==true)
	  		{
	  			if (monsters[m].lane==currentLane && (Math.abs(monsters[m].box-currentBox) <=1)  )
	  			{
	  				actionList.push({code:"battle", param1:m, param2:0});
	  			}
	  			if ((monsters[m].box==0 || monsters[m].box==1) && currentBox==0) 
	  			{
	  				actionList.push({code:"battle", param1:m, param2:0});	
	  			}
	  		}
	  	}

	  	//buy



	  	console.log("Possible actions:");
	  	for (a in actionList)
	  	{
	  		console.log(actionList[a].code+ " P1: "+actionList[a].param1+" P2: "+actionList[a].param2);
	  	}
	  	return actionList;
	  }
		
		function executeAction(code, p1, p2)
		{
			var validAction=false;
			var actionList = getPossibleActions();
			for (a in actionList)
			{
				if (actionList[a].code=="mov" && actionList[a].param1==p1 && actionList[a].param2 == p2)
					validAction=true;

				if (actionList[a].code=="atk" && actionList[a].param1==p1)
					validAction=true;

				if (actionList[a].code=="battle" && actionList[a].param1==p1)
					validAction=true;
			}

			if (validAction==false)
			{
				console.log("Not a valid action: "+code+ " P1: "+p1+" P2: "+p2);
				return;
			}

			if (code=="mov")
			{
				player[currentPlayer].lane=p1;
				player[currentPlayer].box=p2;

				energy--;
			}

			if (code=="battle")
			{
				battleMonster.id=p1;
				switchPhase(phases.battle);
			}

			if (code=="atk")
			{
				startAnimation("sword", battleMonster.x, battleMonster.y);

				var finalDmg=p2-monsters[p1].def;
				if (finalDmg<0) finalDmg=0;
				monsters[p1].hp-=finalDmg;
				dmgText.x=battleMonster.x-24;
				dmgText.y=battleMonster.y-battleMonster.h;
				dmgText.ttl=50;
				dmgText.text="-"+finalDmg;
				if (monsters[p1].hp<=0)
				{
					monsters[p1].alive=false;
					player[currentPlayer].gold+= 5 + (monsters[p1].lvl *2);
				}
				
				console.log("Attacking monster "+p1 +" Hp remaining: "+monsters[p1].hp+"  Alive: "+monsters[p1].alive);
			}

			if (code=="dmg")
			{
				var mons = monsters[battleMonster.id];
				var finalDmg=(Math.floor((Math.random() * mons.atk) + 1))- defInfo[player[currentPlayer].defLvl].val;
				if (finalDmg<0) finalDmg=0;
				player[currentPlayer].hp-= finalDmg;
				dmgText.x=battlePlayer.x-24;
				dmgText.y=battlePlayer.y-battlePlayer.h;
				dmgText.ttl=50;
				dmgText.text="-"+finalDmg;
				console.log("Attacking player "+currentPlayer +" Damage: "+finalDmg+" Hp remaining: "+player[currentPlayer].hp);

			}
		}	  
	  

		//================  EVENTS  ======================

		//spawnMonster(0, 0);
	   var row=7;
	   var n=0;
		canvas.addEventListener('mousedown', function(evt) {
		var rect = canvas.getBoundingClientRect();
		console.log("board[\""+row+"."+n+"\"] = {x:" + Math.round(evt.clientX - rect.left)+ ", y:"+Math.round(evt.clientY-rect.top)+"}");
		n++;

		for (m in monsters)
		{
			console.log("Moving monster, hp"+monsters[m].hp);
			if (monsters[m].box!=13)monsters[m].box--;
		}
      }, false);
      
    </script>
  </body>
</html>     

