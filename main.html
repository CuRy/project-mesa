<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <style>
#hud {
    line-height:30px;
    background-color:#eeeeee;
    height:300px;
    width:100px;
    float:left;
    padding:5px; 
}
</style>
  <body style="width:1900; height:1060">
    <canvas style="float:left;" id="myCanvas" width="1920" height="1060"></canvas>
   

    </div>

   <script src="jquery211.js"></script>
    <script>


    	//================  INIT  ======================
		
		var players = 6;
		var castleHP=50;
		var tmpCastleHP=castleHP;
		var lanes = 8;
		var currentPlayer=0;
		//var monsters=1;
		var turn=0;
		var player=[];
		var charHeight=56;
		var charWidth=28;
		var movSteps=2; //For movement animation
		var sizeSteps=2;	//For scale animation
		var laneLvl =[];
		var monsterInfo=[];
		var monster=[];
		var monsters=[];
		var laneSize=12;
		var summonTurns=3;
		var monsterMoveTurns=2;
		var energy=0;
		var itemInfo=[];
		var damageInfo=[];



		var input=false;


		//HUD
		var boardW=1620;
		var boardH=1060;

		var battleback = {w:640, h:320, tmpw:0, tmph:0};
		var battlePlayer={w:0, h:0, tmph:0,tmpw:0, x:659, y:560};
		var battleMonster={id:0, w:0, h:0, tmph:0,tmpw:0,x:920, y:560};
		var atributeHoffset=50;
		var atributeVoffset=70;
		var monsterBattleIcon={h:48, w:48};

		var animInfo = [];
		var dmgText ={ttl:0,x:0,y:0, text:""};
		var flashVal=30;
		animInfo["sword"] = [];

		animInfo["sword"][0]={x:-100, y:-100, w:0,h:0, sizeStep:48, movStep:16};
		animInfo["sword"][1]={x:0, y:0, w:192,h:192, sizeStep:48, movStep:16};
		animInfo["sword"][2]={x:100, y:100, w:0,h:0, sizeStep:48, movStep:16};

		var currentAnimation={active:false, type:"", stage:0, x:0, y:0, tmpx:0, tmpy:0, w:0, h:0, tmpw:0,tmph:0, basex:0, basey:0};

		var phases = {
			playerChoose:"playerChoose",
			intro:"intro",
			summon:"summon",
			monsterAdvance:"minionAdvance",
			playerEnergy:"playerEnergy",
			playerActions:"playerActions", 
			battle:"battle",
			playerAtk:"playerAtk",
			enemyAtk:"enemyAtk"
		}

		

		board = [];

		board["center"] = {x:827, y:450};
		board["0.13"] = {x:89, y:63};
		board["1.13"] = {x:1177, y:43};
		board["2.13"] = {x:1556, y:203};
		board["3.13"] = {x:1557, y:870};
		board["4.13"] = {x:1198, y:1028};
		board["5.13"] = {x:327, y:1019};
		board["6.13"] = {x:49, y:818};
		board["7.13"] = {x:57, y:292};


		board["0.0"] = {x:766, y:366} ;
		board["0.1"] = {x:794, y:345} ;
		board["0.2"] = {x:794, y:297} ;
		board["0.3"] = {x:729, y:264} ;
		board["0.4"] = {x:663, y:250} ;
		board["0.5"] = {x:633, y:204} ;
		board["0.6"] = {x:583, y:187} ;
		board["0.7"] = {x:520, y:155} ;
		board["0.8"] = {x:453, y:137} ;
		board["0.9"] = {x:389, y:136} ;
		board["0.10"] = {x:324, y:123} ;
		board["0.11"] = {x:257, y:92} ;
		board["0.12"] = {x:211, y:59} ;

		board["1.0"] = {x:894, y:375};
		board["1.1"] = {x:892, y:326};
		board["1.2"] = {x:892, y:280};
		board["1.3"] = {x:943, y:255};
		board["1.4"] = {x:1007, y:256};
		board["1.5"] = {x:1069, y:254};
		board["1.6"] = {x:1134, y:238};
		board["1.7"] = {x:1201, y:239};
		board["1.8"] = {x:1231, y:193};
		board["1.9"] = {x:1216, y:147};
		board["1.10"] = {x:1166, y:129};
		board["1.11"] = {x:1117, y:114};
		board["1.12"] = {x:1067, y:98} ;

		board["2.0"] = {x:970, y:481};
		board["2.1"] = {x:1023, y:478};
		board["2.2"] = {x:1073, y:480};
		board["2.3"] = {x:1122, y:480};
		board["2.4"] = {x:1171, y:479};
		board["2.5"] = {x:1203, y:432};
		board["2.6"] = {x:1267, y:416};
		board["2.7"] = {x:1335, y:416};
		board["2.8"] = {x:1332, y:352};
		board["2.9"] = {x:1351, y:290};
		board["2.10"] = {x:1365, y:227};
		board["2.11"] = {x:1414, y:196};
		board["2.12"] = {x:1480, y:194};

		board["3.0"] = {x:940, y:535};
		board["3.1"] = {x:990, y:549};
		board["3.2"] = {x:1041, y:581};
		board["3.3"] = {x:1090, y:595};
		board["3.4"] = {x:1155, y:627};
		board["3.5"] = {x:1220, y:627};
		board["3.6"] = {x:1283, y:627};
		board["3.7"] = {x:1312, y:671};
		board["3.8"] = {x:1347, y:715};
		board["3.9"] = {x:1379, y:766};
		board["3.10"] = {x:1380, y:827};
		board["3.11"] = {x:1428, y:841};
		board["3.12"] = {x:1478, y:856};

		board["4.0"] = {x:866, y:573};
		board["4.1"] = {x:877, y:626};
		board["4.2"] = {x:893, y:674};
		board["4.3"] = {x:892, y:720};
		board["4.4"] = {x:926, y:751};
		board["4.5"] = {x:973, y:783};
		board["4.6"] = {x:1038, y:800};
		board["4.7"] = {x:1092, y:800};
		board["4.8"] = {x:1154, y:799};
		board["4.9"] = {x:1220, y:814};
		board["4.10"] = {x:1253, y:862};
		board["4.11"] = {x:1268, y:924};
		board["4.12"] = {x:1266, y:987};

		board["5.0"] = {x:792, y:591} ;
		board["5.1"] = {x:794, y:643} ;
		board["5.2"] = {x:796, y:704} ;
		board["5.3"] = {x:813, y:766} ;
		board["5.4"] = {x:811, y:831} ;
		board["5.5"] = {x:780, y:880} ;
		board["5.6"] = {x:697, y:881} ;
		board["5.7"] = {x:632, y:846} ;
		board["5.8"] = {x:566, y:817} ;
		board["5.9"] = {x:502, y:833} ;
		board["5.10"] = {x:440, y:848} ;
		board["5.11"] = {x:373, y:896} ;
		board["5.12"] = {x:323, y:944} ;
		
		board["6.0"] = {x:686, y:501};
		board["6.1"] = {x:651, y:502};
		board["6.2"] = {x:584, y:502};
		board["6.3"] = {x:536, y:534};
		board["6.4"] = {x:536, y:598};
		board["6.5"] = {x:471, y:626};
		board["6.6"] = {x:405, y:628};
		board["6.7"] = {x:357, y:614};
		board["6.8"] = {x:291, y:629};
		board["6.9"] = {x:244, y:663};
		board["6.10"] = {x:192, y:689};
		board["6.11"] = {x:177, y:756};
		board["6.12"] = {x:127, y:786};

		board["7.0"] = {x:678, y:445};
		board["7.1"] = {x:617, y:440};
		board["7.2"] = {x:567, y:424};
		board["7.3"] = {x:488, y:424};
		board["7.4"] = {x:423, y:442};
		board["7.5"] = {x:357, y:441};
		board["7.6"] = {x:357, y:380};
		board["7.7"] = {x:373, y:331};
		board["7.8"] = {x:390, y:285};
		board["7.9"] = {x:374, y:223};
		board["7.10"] = {x:307, y:222};
		board["7.11"] = {x:225, y:206};
		board["7.12"] = {x:163, y:222};

		
		
		monsterInfo[0]={lvl:1, vit:4, atk:4, def:0,w:50,h:50};
		monsterInfo[25]={lvl:26, vit:50, atk:12, def:3,w:135,h:101};
		
		var atkMax=5;
		var vitMax=6;
		var defMax=5;
		var enrMax=5;

		itemInfo["atk"] = [];
		itemInfo["vit"] = [];
		itemInfo["def"] = [];
		itemInfo["enr"] = [];
		itemInfo["pot"] = [];

		itemInfo["atk"][0]={cost:0, val:4, w:56, h:84};
		itemInfo["atk"][1]={cost:40, val:6, w:56, h:84};
		itemInfo["atk"][2]={cost:60, val:8, w:56, h:84};
		itemInfo["atk"][3]={cost:100, val:10, w:56, h:84};
		itemInfo["atk"][4]={cost:160, val:12, w:56, h:84};

		itemInfo["vit"][0]={cost:0, val:25, w:56, h:56};
		itemInfo["vit"][1]={cost:20, val:30, w:56, h:56};
		itemInfo["vit"][2]={cost:30, val:35, w:56, h:56};
		itemInfo["vit"][3]={cost:50, val:40, w:56, h:56};
		itemInfo["vit"][4]={cost:80, val:45, w:56, h:56};
		itemInfo["vit"][5]={cost:120, val:50, w:56, h:56};

		itemInfo["def"][0]={cost:0, val:0, w:56, h:84};
		itemInfo["def"][1]={cost:30, val:1, w:56, h:84};
		itemInfo["def"][2]={cost:50, val:2, w:56, h:84};
		itemInfo["def"][3]={cost:90, val:3, w:56, h:84};
		itemInfo["def"][4]={cost:150, val:4, w:56, h:84};
		itemInfo["def"][5]={cost:230, val:5, w:56, h:84};

		itemInfo["enr"][0]={cost:0, val:4, w:56, h:56};
		itemInfo["enr"][1]={cost:15, val:6, w:56, h:56};
		itemInfo["enr"][2]={cost:20, val:8, w:56, h:56};
		itemInfo["enr"][3]={cost:30, val:10, w:56, h:56};
		itemInfo["enr"][4]={cost:50, val:12, w:56, h:56};
		
		itemInfo["pot"][0]={cost:4, val:10, w:48, h:48};

		for (var i=0;i<lanes;i++)
		{
			laneLvl[i] = 0;

		}
		
		var canvas = document.getElementById('myCanvas');
			var context = canvas.getContext('2d');
			var boardImg = new Image();
			//var charImg = new Image();
			var battlebackImg = new Image();
			var cancelImg = new Image();
			var images = {};
			var monsterImg = {};
			var itemImg=[];

		
			var animImg=[];
			var charImg=[];
			var faceImg=[];
			context.imageSmoothingEnabled = true;
			var buttons=[];

			
		function loadImages(sources) {
        for(var src in sources) {
          images[src] = new Image();
          images[src].src = sources[src];
          }

          monsterImg[0]=new Image();
          monsterImg[0].src = "monster/monster1.png";

          monsterImg[25]=new Image();
          monsterImg[25].src = "monster/monster25.png";

          battlebackImg.src = "battleback.jpg";

          monsterAtkImg = new Image();
          monsterDefImg = new Image();
          monsterHpImg = new Image();
          goldImg = new Image();
          hudImg = new Image();
          hudImg1 = new Image();
          hudImg2 = new Image();
          movImg = new Image();
          cancelImg = new Image();
          energyImg = new Image();
          endImg = new Image();
          monsterAtkImg.src = "items/atkIcon.png";
          monsterDefImg.src = "items/defIcon.png";
          monsterHpImg.src = "items/hpIcon.png";
          goldImg.src="items/gold.png";
          hudImg.src="hudback.jpg";
          hudImg1.src="hudback1.jpg";
          hudImg2.src="hudback2.jpg";
          movImg.src="icon/mov.png";
          cancelImg.src="icon/cancel.png";
          energyImg.src="icon/energy.png";
          endImg.src="icon/end.png";


		 itemImg["def"]=[];
          for (var d in itemInfo["def"])
          {
          	itemImg["def"][d]=new Image();
          	itemImg["def"][d].src= "items/armor"+d+".gif";
          }
          itemImg["atk"]=[];
          for (var d in itemInfo["atk"])
          {
          	itemImg["atk"][d]=new Image();
          	itemImg["atk"][d].src= "items/sword"+d+".gif";
          }
          itemImg["vit"]=[];
          for (var d in itemInfo["vit"])
          {
          	itemImg["vit"][d]=new Image();
          	itemImg["vit"][d].src= "items/helm"+d+".gif";
          }
          itemImg["enr"]=[];
          for (var d in itemInfo["enr"])
          {
          	itemImg["enr"][d]=new Image();
          	itemImg["enr"][d].src= "items/boots"+d+".gif";
          }

	   	  itemImg["pot"]=[];
		  itemImg["pot"][0]=new Image();
          itemImg["pot"][0].src= "items/potion.png";


          for (var i=0;i<13;i++)
          {
          	charImg[i]=new Image();
          	charImg[i].src= "chars/char"+i+".png";
          }
          for (var i=0;i<13;i++)
          {
          	faceImg[i]=new Image();
          	faceImg[i].src= "face/face"+i+".png";
          }

      
          animImg["sword"]=new Image();
          animImg["sword"].src="anim/sword.png";
        }
      
    

      var sources = {
        boardImg: "board.png",

      };

      loadImages(sources);
	  setInterval(function(){render()}, 30);
	  setInterval(function(){processAction()}, 100);
	  

	  //================  ACTION  ======================

	  var phaseControl=0;
	  var phaseComplete=[0, 0, 0, 0, 0];
	  var phaseValue=[0, 0, 0, 0, 0];
	  var waitLeft=0;
	
	  var action = {
	  	code:"",
	  	param1:"",
	  	param2:""
	  };

		switchPhase(phases.intro);

	  function inp(){
	  	input=true; 
	  	console.log("user input");
	  }

	  function switchPhase(toPhase)
	  {
	  	if (toPhase==phases.intro)
	  	{
	  		phaseControl=0;
	  		phaseComplete[0]=lanes;
	  		phaseComplete[1]=players;
	  		phaseValue[0]=0;
	  		phaseValue[0]=0;

	  		phase=phases.intro;
	  	}

	  	if (toPhase==phases.summon)
	  	{
	  		phase=phases.summon;
	  	}

		if (toPhase==phases.monsterAdvance)
	  	{
	  		phaseComplete[0]=0;
		  	phaseValue[0]=0;

	  		for (m in monsters)
	  		{
	  			
	  			if (monsters[m].lvl < 25 && monsters[m].alive==true)
	  			{
	  				monsters[m].toAdvance--;
	  				if (monsters[m].toAdvance==0)
	  					phaseComplete[0]++;
	  			}

	  		}

	  		phase=phases.monsterAdvance;
	  	}

	  	 if (toPhase==phases.playerEnergy)
	  	{

	  		phase=phases.playerEnergy;
	  	}

	  	if (toPhase==phases.playerActions)
	  	{
	  		input=false;
	  		phase=phases.playerActions;
	  		
	  	}

	  	if (toPhase==phases.battle)
	  	{
	  		input=false;
	  		
	  		battlePlayer.w=charWidth*2;
	  		battlePlayer.h=charHeight*2;
	  		
	  		battleMonster.w=monsterInfo[monsters[battleMonster.id].lvl].w*2;
	  		battleMonster.h=monsterInfo[monsters[battleMonster.id].lvl].h*2;

	  		//console.log("monster lvl "+battleMonster.w);

	  		battlePlayer.tmpw=0;
	  		battlePlayer.tmph=0;
	  		battleMonster.tmpw=0;
	  		battleMonster.tmph=0;

	  		flashVal=30;
	  		phase=phases.battle;
	  		
	  	}

	  	console.log("Phase is: "+phase);
	  }

	  function wait(time) {
	  	waitLeft+=time;
	  }


	  function processAction()
	  {
	  	if (waitLeft>0){
	  		waitLeft--;
	  		return;
	  	}



	  	for (m in monsters)
	  	{
	  		var mon=monsters[m];
	  		(mon.hp<mon.tmphp)?mon.tmphp--:0;
	  	}

	  	for (p=0;p<player.length;p++)
	  	{
	  		var pl=player[p];
	  		(pl.hp<pl.tmphp)?pl.tmphp--:0;
	  		(pl.hp>pl.tmphp)?pl.tmphp++:0;	 
	  		(pl.gold<pl.tmpgold)?pl.tmpgold--:0;
	  		(pl.gold>pl.tmpgold)?pl.tmpgold++:0;	 		
	  	}
	
	  	
	  	//================   PHASE INTRO ======================
	  	if (phase==phases.intro)
	  	{
	  		if (phaseControl==0)
	  		{
	  			if (phaseValue[0]<phaseComplete[0])
	  			{
	  				spawnMonster(phaseValue[0], 25, true);
	  				phaseValue[0]++
	  			}
	  			else
	  				phaseControl++;

	  			
	  		}
	  		if (phaseControl==1)
	  		{
	  			if (phaseValue[1]<phaseComplete[1])
	  			{
					player[phaseValue[1]] = {
						lane:phaseValue[1], 
						box:0, 
						x:board["center"].x, 
						y:board["center"].y, 
						tmpx:board["center"].x, 
						tmpy:board["center"].y, 
						vitLvl:0, 
						hp:itemInfo["vit"][0].val, 
						tmphp:itemInfo["vit"][0].val, 
						atkLvl:0, 
						defLvl:0, 
						enrLvl:0, 
						tmpgold: 0, 
						gold:1000, 
						turnsToLive:0,
						alive:true, 
						character:phaseValue[1]
					};
					phaseValue[1]++;
	  			}
	  			else
	  			phaseControl++
	  		}
	  		wait(8);
	  		if (phaseControl==2)
	  			switchPhase(phases.monsterAdvance);
	  	}

		//================  PHASE SUMMON  ======================
	  	if (phase==phases.summon)
	  	{
	  		//var lane = $("#param1").val();
	  		//console.log("spawnMonster on lane "+ lane);
	  		var spawnLane=Math.floor((Math.random() * lanes));
	  		spawnMonster(spawnLane, laneLvl[spawnLane]);
	  		laneLvl[spawnLane]++;
	  		switchPhase(phases.playerEnergy);
	  	}

		//================  PHASE MONSTER ADVANCE ======================
	  	if (phase==phases.monsterAdvance)
	  	{
	  		for (m in monsters)
	  		{
	  			
	  			if (monsters[m].lvl < 25 && monsters[m].alive==true)
	  			{
	  				if (monsters[m].toAdvance==0)
	  				{
	  					console.log("Monster lvl "+monsters[m].lvl+" in lane "+ monsters[m].lane + " advances");
		  				if (monsters[m].box>0)
		  					monsters[m].box--;
		  				else
		  					attackCastle(monsters[m].lvl);

		  				monsters[m].toAdvance=monsterMoveTurns;
		  				phaseValue[0]++;
	  				}


	  			}


	  		}
	  		if (phaseValue[0]==phaseComplete[0])
	  		switchPhase(phases.summon);

	  	}

		//================  PHASE PLAYER ENERGY ======================
		if (phase==phases.playerEnergy)
		{
			if (player[currentPlayer].alive==false)
			{
				player[currentPlayer].alive=true;
				player[currentPlayer].hp=itemInfo["vit"][player[currentPlayer].vitLvl].val;
				nextTurn();
				wait(20);
				return;
			}
			context.drawImage(faceImg[player[currentPlayer].character], board["center"].x-64, board["center"].y-64, 128, 128);
			energy=prompt("Energia del jugador "+currentPlayer+1);//$("#param1").val();
			switchPhase(phases.playerActions);
		}

		//================  PHASE PLAYER ACTIONS ======================
		if (phase==phases.playerActions && input==true)
		{
			aCode=$("#code").val();
			aP1=$("#param1").val();
			aP2=$("#param2").val();
			//executeAction(aCode, aP1, aP2);
			//getPossibleActions();
			input=false;
		}

		if (phase==phases.battle)
		{
			if (player[currentPlayer].hp<=0)
			{
				player[currentPlayer].x=board["center"].x;
				player[currentPlayer].y=board["center"].y;
				player[currentPlayer].tmpx=board["center"].x;
				player[currentPlayer].tmpy=board["center"].y;
				player[currentPlayer].lane=getRandomInt(lanes-1);
				player[currentPlayer].box=0;
				player[currentPlayer].alive=false;
				player[currentPlayer].gold=Math.floor(player[currentPlayer].gold*0.8);
				wait(10);
				nextTurn();

			}
		}

	  }

	  

	  //================  RENDER  ======================
	 
		function render()
		{
			
			
			//console.log("Rendering");
			
			context.drawImage(images.boardImg, 0, 0, 1620, 1060);
			drawPlayers();
			drawMonsters();
			
			drawHUD();
			drawBattle();
			drawAnimation();

		}

		function drawPlayers()
		{
			
			
			//console.log(boardpos);
			for (var i=0;i<players;i++)
			{
				if (typeof player[i] !== 'undefined' && player[i].alive==true)
				{
				player[i].x=boardX(player[i].lane, player[i].box);
				player[i].y=boardY(player[i].lane, player[i].box);
				(player[i].tmpx-player[i].x<movSteps)?player[i].tmpx+=movSteps:0;
				(player[i].tmpx-player[i].x>movSteps)?player[i].tmpx-=movSteps:0;
				(player[i].tmpy-player[i].y<movSteps)?player[i].tmpy+=movSteps:0;
				(player[i].tmpy-player[i].y>movSteps)?player[i].tmpy-=movSteps:0;
				
				context.drawImage(charImg[player[i].character], player[i].tmpx-(charWidth/2), player[i].tmpy-(charHeight/2), charWidth, charHeight);
				}
			}

		}
		
      	function drawMonsters()
      	{

			
			for (var i=0;i<monsters.length;i++)
			{
				var mons = monsters[i];
				//console.log("monster lane: "+mons.lane);
				mons.x = boardX(mons.lane, mons.box);

				mons.y = boardY(mons.lane, mons.box);

				var lvl =mons.lvl;
				if (mons.alive)
				{
				(mons.tmpw - monsterInfo[lvl].w<sizeSteps) ? mons.tmpw+=sizeSteps : 0;
				(mons.tmph - monsterInfo[lvl].h<sizeSteps) ? mons.tmph+=sizeSteps : 0;

				(mons.tmpx - mons.x<movSteps) ? mons.tmpx+=movSteps : 0;
				(mons.tmpy - mons.y<movSteps) ? mons.tmpy+=movSteps : 0;
				(mons.tmpx - mons.x>movSteps) ? mons.tmpx-=movSteps : 0;
				(mons.tmpy - mons.y>movSteps) ? mons.tmpy-=movSteps : 0;


				}
				if (!mons.alive)
				{ 
					(mons.tmpw >0) ? mons.tmpw-=sizeSteps : 0;
					(mons.tmph >0) ? mons.tmph-=sizeSteps : 0;
				}
				context.drawImage(monsterImg[mons.lvl], mons.tmpx-(mons.tmpw/2), mons.tmpy-(mons.tmph/2), mons.tmpw, mons.tmph);
			}
      	}

      	function drawHUD()
      	{
      		
      		//context.fillRect(0, 0, 2000, 2000);
      		var iconsmall=56;
      		var iconbig=84;
      		var hpBarh=10;
      		var infoBoxW=112;
			var infoBoxH=206;
			var texth=16;
			context.fillStyle = "#CCCCCC";
      		context.fillRect(boardW, 0, infoBoxW*2, boardH);

			if (phase==phases.playerEnergy && player[currentPlayer].alive==true)
			{

				context.drawImage(faceImg[player[currentPlayer].character], board["center"].x-64, board["center"].y-64, 128, 128);
			}

			for (var i=0;i<player.length;i++)
			{
			var basex;
			var basey;
			if (i==0){
				basex=0;
				basey=0;
				context.drawImage(hudImg1, boardW+basex, basey, infoBoxW, infoBoxH);
			}else if (i==1) {
				basex=infoBoxW;
				basey=0;
				context.drawImage(hudImg2, boardW+basex, basey, infoBoxW, infoBoxH);
			}else if (i==2) {
				basex=0;
				basey=infoBoxH;
				context.drawImage(hudImg2, boardW+basex, basey, infoBoxW, infoBoxH);
			}else if (i==3) {
				basex=infoBoxW;
				basey=infoBoxH;
				context.drawImage(hudImg1, boardW+basex, basey, infoBoxW, infoBoxH);
			}else if (i==4) {
				basex=0;
				basey=infoBoxH*2;
				context.drawImage(hudImg1, boardW+basex, basey, infoBoxW, infoBoxH);
			}else if (i==5) {
				basex=infoBoxW;
				basey=infoBoxH*2;
				context.drawImage(hudImg2, boardW+basex, basey, infoBoxW, infoBoxH);
			};

			//context.drawImage(hudImg, boardW+basex, basey, infoBoxW, infoBoxH);
      		context.drawImage(faceImg[player[i].character], boardW+basex, 	basey, infoBoxW/2, 56);
      		context.fillStyle = "red";
      		context.fillRect(basex+boardW, basey+iconsmall, iconsmall, hpBarh);
      		var barw = iconsmall * (player[i].tmphp / itemInfo["vit"][player[i].vitLvl].val);
			context.fillStyle = "green";
      		context.fillRect(basex+boardW, basey+iconsmall, barw, hpBarh);
      		context.fillStyle="black";
      		context.font="bold 12px Arial";
      		context.fillText("Vit: "+player[i].tmphp +"/"+itemInfo["vit"][player[i].vitLvl].val, basex+boardW+iconsmall, basey+10);
      		context.fillText("Atk: "+itemInfo["atk"][player[i].atkLvl].val, basex+boardW+iconsmall, basey+10+texth);
      		context.fillText("Def: "+itemInfo["def"][player[i].defLvl].val, basex+boardW+iconsmall, basey+10+texth*2);
      		context.fillText("Enr: "+itemInfo["enr"][player[i].enrLvl].val, basex+boardW+iconsmall, basey+10+texth*3);
      		context.fillStyle="#666600";
      		context.font="bold 15px Arial";
      		context.textAlign="right";
      		context.fillText("$"+player[i].tmpgold, basex+boardW+iconsmall, basey+15+hpBarh+iconsmall);
      		context.fillStyle="black";
      		context.font="10px Arial";
      		context.textAlign="left";
      		context.drawImage(itemImg["vit"][player[i].vitLvl], basex+boardW+iconsmall, basey+iconsmall+hpBarh, infoBoxW/2, 56);
      		context.drawImage(itemImg["def"][player[i].defLvl], basex+boardW+iconsmall, basey+iconsmall*2+hpBarh, infoBoxW/2, 84);
      		context.drawImage(itemImg["atk"][player[i].atkLvl], basex+boardW, basey+iconsmall+hpBarh, infoBoxW/2, 84);
      		context.drawImage(itemImg["enr"][player[i].enrLvl], basex+boardW, basey+iconsmall+iconbig+hpBarh, infoBoxW/2, 56);
			}

			//if (phase==phases.playerActions)
			{
				buttons = [];
				var aList = getPossibleActions();
				var buyList=0;
				for (a in aList)
				{ 
					
					if (aList[a].code=="cancel")
					{
					buttons.push({
						x:boardW,
						y:infoBoxH*3+(32*a),
						h:32,
						w:32,
						action:aList[a].code,
						p1:aList[a].param1,
						p2:aList[a].param2
					})
					}
					if (aList[a].code=="mov" || aList[a].code=="battle")
					{
					buttons.push({
						x:boardW,
						y:infoBoxH*3+(32*a),
						h:32,
						w:32,
						action:aList[a].code,
						p1:aList[a].param1,
						p2:aList[a].param2
					})
					}
					else if (aList[a].code=="end")
					{
					buttons.push({
						x:boardW,
						y:infoBoxH*3+(32*a),
						h:32,
						w:32,
						action:aList[a].code,
						p1:aList[a].param1,
						p2:aList[a].param2
					})
					}
					else if (aList[a].code=="atk")
					{
						buttons.push({
						x:battleMonster.x - (battleMonster.w/2),
						y:battleMonster.y - (battleMonster.h/2),
						h:battleMonster.h,
						w:battleMonster.w,
						action:aList[a].code,
						p1:aList[a].param1,
						p2:aList[a].param2
						});
						//console.log("battleMonster.x");
					}
					else if (aList[a].code=="dmg")
					{
						buttons.push({
						x:battlePlayer.x - (battlePlayer.w/2),
						y:battlePlayer.y - (battlePlayer.h/2),
						h:battlePlayer.h,
						w:battlePlayer.w,
						action:aList[a].code,
						p1:aList[a].param1,
						p2:aList[a].param2
						});
					}
					else if (aList[a].code=="buy")
					{
						buttons.push({
						x:boardW+infoBoxW,
						y:infoBoxH*3+(32*buyList)+56,
						h:32,
						w:32,
						action:aList[a].code,
						p1:aList[a].param1,
						p2:aList[a].param2
					})
						buyList++;
					}
				}
			}

			context.fillStyle="black";
      		context.font="bold 48px Arial";
			if (buttons.length>0)
			{
				txt = energy;
				context.drawImage(faceImg[player[currentPlayer].character], boardW-48+infoBoxW*2, infoBoxH*3, 48,48);
				context.fillText(txt, boardW-48-48+infoBoxW*2, infoBoxH*3+48);
			}

			context.fillStyle="black";
      		context.font="10px Arial";
			for (b in buttons){
				var button= buttons[b];
				
				var txt;
				if (button.action=="mov")
				{
					txt = "Lane "+(button.p1-0+1) + " box "+button.p2;
					context.drawImage(movImg, button.x, button.y, button.w, button.h);
					context.fillText(txt, button.x+button.w, button.y+(button.h/2));
				}


				if (button.action=="battle")
				{
					txt = "Lane "+monsters[button.p1].lane + " ("+monsters[button.p1].hp+")";
					context.drawImage(monsterImg[monsters[button.p1].lvl], button.x, button.y, button.w, button.h);
					context.fillText(txt, button.x+button.w, button.y+(button.h/2));
				}
				if (button.action=="end")
				{
					//txt = "Lane "+button.p1 + " box "+button.p2;
					context.drawImage(endImg, button.x, button.y, button.w, button.h);
					//context.fillText(txt, button.x+button.w, button.y+(button.h/2));
				}
				if (button.action=="buy")
				{
					txt = button.p1 + ": " + itemInfo[button.p1][button.p2].val+ " ("+itemInfo[button.p1][button.p2].cost+"g)" ;
					context.drawImage(itemImg[button.p1][button.p2], button.x, button.y, button.w, button.h);
					context.fillText(txt, button.x+button.w, button.y+(button.h/2));
				}

				if (button.action=="cancel")
				{
					
					context.drawImage(cancelImg, button.x, button.y, button.w, button.h);
					
				}

				
			}
      		
      	}

      	function drawBattle()
      	{
      		wset=false;
      		hset=false;
      		if (phase==phases.battle)
      		{
      			(battleback.tmpw<battleback.w) ? battleback.tmpw+=sizeSteps * 15:wset=true;
      			(battleback.tmph<battleback.h) ? battleback.tmph+=sizeSteps * 15:hset=true;

      			if (wset && hset)
      			{

      				(battlePlayer.tmpw<battlePlayer.w) ? battlePlayer.tmpw+=sizeSteps*3:0;
      				(battlePlayer.tmph<battlePlayer.h) ? battlePlayer.tmph+=sizeSteps*3:0;

      				(battleMonster.tmpw<battleMonster.w) ? battleMonster.tmpw+=sizeSteps*3:0;
      				(battleMonster.tmph<battleMonster.h) ? battleMonster.tmph+=sizeSteps*3:0;
      				//console.log(battleMonster.tmpw+"  "+battleMonster.w);
      				//console.log(battleMonster.tmph+"  "+battleMonster.h);
      			}


      			
      		}
      		if (phase!=phases.battle)
      		{
      			(battleback.tmpw>0) ? battleback.tmpw-=sizeSteps * 10:0;
      			(battleback.tmph>0) ? battleback.tmph-=sizeSteps * 10:0;
      		}

      		context.drawImage(battlebackImg, (boardW/2)-(battleback.tmpw/2), (boardH/2)-(battleback.tmph/2), battleback.tmpw,battleback.tmph);
      		if (wset && hset)
      		{
      			var mons = monsters[battleMonster.id];

      			if (player[currentPlayer].hp>0)      			{
      				context.drawImage(charImg[player[currentPlayer].character], battlePlayer.x-(battlePlayer.tmpw/2), battlePlayer.y-(battlePlayer.tmph/2), battlePlayer.tmpw,battlePlayer.tmph);
      			} else{
 
      				if (flashVal%2==1&& flashVal>0)
      				{
      					context.drawImage(charImg[player[currentPlayer].character], battlePlayer.x-(battlePlayer.tmpw/2), battlePlayer.y-(battlePlayer.tmph/2), battlePlayer.tmpw,battlePlayer.tmph);      					
      					flashVal--;
      				}
      				
      			}

      			if (monsters[battleMonster.id].hp>0)
      			{
      				context.drawImage(monsterImg[mons.lvl], battleMonster.x-(battleMonster.tmpw/2), battleMonster.y-(battleMonster.tmph/2), battleMonster.tmpw,battleMonster.tmph);
      			}else{
      				if (flashVal%2==1 && flashVal>0)
      				{
      					context.drawImage(monsterImg[mons.lvl], battleMonster.x-(battleMonster.tmpw/2), battleMonster.y-(battleMonster.tmph/2), battleMonster.tmpw,battleMonster.tmph);
      					flashVal--;
      				}
      				
      		
      			}
				
				context.fillStyle = 'black';
				var atklvl =player[currentPlayer].atkLvl;
				var deflvl =player[currentPlayer].defLvl;
				var vitlvl =player[currentPlayer].vitLvl;

				var atkIconX = (boardW/2)-(battleback.w/2)+atributeHoffset-(itemInfo["atk"][atklvl].w/2);
				var atkIconY = (boardH/2)+0-(itemInfo["atk"][atklvl].h/2);
				context.drawImage(itemImg["atk"][atklvl], atkIconX, atkIconY, itemInfo["atk"][atklvl].w,itemInfo["atk"][atklvl].h);

				var vitIconX = (boardW/2)-(battleback.w/2)+atributeHoffset-(itemInfo["atk"][atklvl].w/2);
				var vitIconY = (boardH/2)-atributeVoffset-(itemInfo["atk"][atklvl].h/2);
				context.drawImage(itemImg["vit"][atklvl], vitIconX, vitIconY, itemInfo["vit"][vitlvl].w,itemInfo["vit"][vitlvl].h);

				var defIconX = (boardW/2)-(battleback.w/2)+atributeHoffset-(itemInfo["def"][deflvl].w/2);
				var defIconY = (boardH/2)+atributeVoffset-(itemInfo["def"][deflvl].h/2);
				context.drawImage(itemImg["def"][deflvl], defIconX, defIconY+28, itemInfo["def"][deflvl].w,itemInfo["def"][deflvl].h);

				var textOffset=30
				context.font="50px Aharoni";
				context.fillText(itemInfo["atk"][player[currentPlayer].atkLvl].val,atkIconX+textOffset+itemInfo["atk"][atklvl].w/2, atkIconY+itemInfo["atk"][atklvl].h/2);

				context.fillText(player[currentPlayer].tmphp,vitIconX+textOffset+itemInfo["vit"][vitlvl].w/2, vitIconY+itemInfo["vit"][vitlvl].h/2);

				context.fillText(itemInfo["def"][player[currentPlayer].defLvl].val,defIconX+textOffset+itemInfo["def"][deflvl].w/2, defIconY+28+itemInfo["def"][deflvl].h/2);
				//-------

				var atkIconX = (boardW/2)+(battleback.w/2)-atributeHoffset-(monsterBattleIcon.w/2);
				var atkIconY = (boardH/2)+0-(monsterBattleIcon.h/2);
				context.drawImage(monsterAtkImg, atkIconX, atkIconY, monsterBattleIcon.w, monsterBattleIcon.h);

				var vitIconX = (boardW/2)+(battleback.w/2)-atributeHoffset-(monsterBattleIcon.w/2);
				var vitIconY = (boardH/2)-atributeVoffset-(monsterBattleIcon.h/2);
				context.drawImage(monsterHpImg, vitIconX, vitIconY, monsterBattleIcon.w,monsterBattleIcon.h);

				var defIconX = (boardW/2)+(battleback.w/2)-atributeHoffset-(monsterBattleIcon.w/2);
				var defIconY = (boardH/2)+atributeVoffset-(monsterBattleIcon.h/2);
				context.drawImage(monsterDefImg, defIconX, defIconY, monsterBattleIcon.w,monsterBattleIcon.h);
				
				context.fillText(monsters[battleMonster.id].atk,atkIconX-textOffset*2+monsterBattleIcon.w/2, atkIconY+monsterBattleIcon.h/2+10);

				context.fillText(monsters[battleMonster.id].tmphp,vitIconX-textOffset*2+monsterBattleIcon.w/2, vitIconY+monsterBattleIcon.h/2+10);

				context.fillText(monsters[battleMonster.id].def,defIconX-textOffset*2+monsterBattleIcon.w/2, defIconY+monsterBattleIcon.h/2+10);

				if (dmgText.ttl>0)
				{
					context.fillStyle = 'red';
					context.fillText(dmgText.text,dmgText.x, dmgText.y);
					dmgText.ttl--;
				}



      		}
      		//context.drawImage(battlebackImg, 100, 100, 100,100);
      	}

      	function drawAnimation()
      	{

      		if (currentAnimation.active)
      		{
      			var movStep= animInfo[currentAnimation.type][currentAnimation.stage].movStep;
      			var sizeStep= animInfo[currentAnimation.type][currentAnimation.stage].sizeStep;
      			if (animInfo[currentAnimation.type][currentAnimation.stage].x-animInfo[currentAnimation.type][currentAnimation.stage-1].x > 0)
      				(currentAnimation.x -currentAnimation.tmpx > movStep) ? currentAnimation.tmpx+=movStep : currentAnimation.tmpx=currentAnimation.x;

				if (animInfo[currentAnimation.type][currentAnimation.stage].y-animInfo[currentAnimation.type][currentAnimation.stage-1].y > 0)
				(currentAnimation.y - currentAnimation.tmpy> movStep) ? currentAnimation.tmpy+=movStep : currentAnimation.tmpy=currentAnimation.y;

				if (animInfo[currentAnimation.type][currentAnimation.stage].x-animInfo[currentAnimation.type][currentAnimation.stage-1].x < 0)
				(currentAnimation.tmpx - currentAnimation.x>movStep) ? currentAnimation.tmpx-=movStep :0;

				if (animInfo[currentAnimation.type][currentAnimation.stage].y-animInfo[currentAnimation.type][currentAnimation.stage-1].y < 0)
				(currentAnimation.tmpy - currentAnimation.y>movStep) ? currentAnimation.tmpy-=movStep :0;

				if (animInfo[currentAnimation.type][currentAnimation.stage].w-animInfo[currentAnimation.type][currentAnimation.stage-1].w > 0)
				(currentAnimation.w-currentAnimation.tmpw > movStep) ? currentAnimation.tmpw+=sizeStep :currentAnimation.tmpw=currentAnimation.w;;

				if (animInfo[currentAnimation.type][currentAnimation.stage].h-animInfo[currentAnimation.type][currentAnimation.stage-1].h > 0)
				(currentAnimation.h - currentAnimation.tmph >movStep) ? currentAnimation.tmph+=sizeStep :currentAnimation.tmph=currentAnimation.h;;

				if (animInfo[currentAnimation.type][currentAnimation.stage].w-animInfo[currentAnimation.type][currentAnimation.stage-1].w < 0)
				(currentAnimation.tmpw - currentAnimation.w>movStep) ? currentAnimation.tmpw-=sizeStep :currentAnimation.tmpw=currentAnimation.w;;

				if (animInfo[currentAnimation.type][currentAnimation.stage].h-animInfo[currentAnimation.type][currentAnimation.stage-1].h < 0)
				(currentAnimation.tmph - currentAnimation.h>movStep) ? currentAnimation.tmph-=sizeStep :currentAnimation.tmph=currentAnimation.h; ;

				if (currentAnimation.tmpx==currentAnimation.x && 
					currentAnimation.tmpy== currentAnimation.y && 
					currentAnimation.tmpw== currentAnimation.w &&
					currentAnimation.tmph==currentAnimation.h)
				{
					if (currentAnimation.stage<animInfo[currentAnimation.type].length-1)
					{
						currentAnimation.stage++;
	  					currentAnimation.x=animInfo[currentAnimation.type][currentAnimation.stage].x;
	  					currentAnimation.y=animInfo[currentAnimation.type][currentAnimation.stage].y;
	  					currentAnimation.w=animInfo[currentAnimation.type][currentAnimation.stage].w;
	  					currentAnimation.h=animInfo[currentAnimation.type][currentAnimation.stage].h;
					}
					else
						currentAnimation.active=false;
				}


				console.log("Animating "+currentAnimation.tmpw+" "+currentAnimation.w+" -- "+currentAnimation.tmph+" "+currentAnimation.h +"  "+movStep);
				context.drawImage(animImg[currentAnimation.type], currentAnimation.basex+ currentAnimation.tmpx-(currentAnimation.tmpw/2), currentAnimation.basey+ currentAnimation.tmpy-(currentAnimation.tmph/2), currentAnimation.tmpw,currentAnimation.tmph);
      		}
      	}



      	//================  AUX FUNCTIONS  ======================

      	function boardX(lane, box)
      	{
			var boardpos=""+lane+"."+box;
			//console.log(boardpos);
			return board[boardpos].x;
      	}

      	function boardY(lane, box)
      	{
			var boardpos=""+lane+"."+box;
			return board[boardpos].y;
      	}
	  
	  function startAnimation(anim, x, y)
	  {
	  	currentAnimation.active=true;
	  	currentAnimation.type=anim;
	  	currentAnimation.tmpx=animInfo[anim][0].x;
	  	currentAnimation.tmpy=animInfo[anim][0].y;
	  	currentAnimation.x=animInfo[anim][1].x;
	  	currentAnimation.y=animInfo[anim][1].y;

	  	currentAnimation.tmpw=animInfo[anim][0].w;
	  	currentAnimation.tmph=animInfo[anim][0].h;
	  	currentAnimation.w=animInfo[anim][1].w;
	  	currentAnimation.h=animInfo[anim][1].h;

	  	currentAnimation.basex=x;
	  	currentAnimation.basey=y;

	  	currentAnimation.stage=1;
	  }
	  function spawnMonster(lane, lvl, boss)
	  {
	  	/*monster[lane][lvl].alive=1;
	  	monster[lane][lvl].tmpx =  board[""+lane+".13"].x;
	  	monster[lane][lvl].tmpy =  board[""+lane+".13"].y;
	  	*/
	  	console.log("Spawning lvl "+lvl+" monster at lane "+lane);
	  	var box = (boss==true)?13:laneSize;

	  	monsters.push({
	  		lvl:lvl, 
	  		hp:monsterInfo[lvl].vit, 
	  		tmphp:monsterInfo[lvl].vit, 
	  		alive:true,
	  		lane:lane, 
	  		box:box, 
	  		def:monsterInfo[lvl].def, 
	  		tmpx:boardX(lane,13), 
	  		tmpy:boardY(lane, 13), 
	  		x:boardX(lane, box), 
	  		y:boardY(lane, box),
	  		atk:monsterInfo[lvl].atk, 
	  		tmpw:0, 
	  		tmph:0, 
	  		toAdvance:monsterMoveTurns
	  	});
	  }


	  function attackCastle(monsterLvl)
	  {
	  	var atk = monsterInfo[monsterLvl].atk;
	  	var dmg = Math.floor((Math.random() * atk) + 1);
	  	castleHP-=dmg;
	  }

	  function getPossibleActions()
	  {
	  	if (phase==phases.intro) return;
	  	var actionList=[];
	  	var currentBox = player[currentPlayer].box;
	  	var currentLane = player[currentPlayer].lane;

	  	//battle
	  	if (phase==phases.battle){
	  		actionList.push({code:"atk", param1:battleMonster.id, param2:0});
	  		actionList.push({code:"dmg", param1:battleMonster.id, param2:0});
	  		actionList.push({code:"cancel", p1:0, p2:0});
	  	}


	  	//move
	  	if (currentBox>0)
	  		actionList.push({code:"mov", param1:currentLane, param2:currentBox-1});

	  	if (currentBox<laneSize)
	  		actionList.push({code:"mov", param1:currentLane, param2:(currentBox-0+1)});

	  	if (currentBox==0)
	  	{
	  		for (var l=0;l<lanes;l++)
	  			if (l!=player[currentPlayer].lane)
	  			actionList.push({code:"mov", param1:l, param2:1});
	  	}
	  	
	  	//battle
	  	for (m in monsters)
	  	{
	  		if (monsters[m].alive==true)
	  		{
	  			if (monsters[m].lane==currentLane && (Math.abs(monsters[m].box-currentBox) <=1)  )
	  			{
	  				actionList.push({code:"battle", param1:m, param2:0});
	  			}
	  			if ((monsters[m].box==0 || monsters[m].box==1) && currentBox==0) 
	  			{
	  				actionList.push({code:"battle", param1:m, param2:0});	
	  			}
	  		}
	  	}

		if (phase==phases.playerActions)
		{
			actionList.push({code:"end", param1:0, param2:0});	
		}
	  	//buy
	  	if (currentBox==0)
	  	{
	  		if (player[currentPlayer].vitLvl<itemInfo["vit"].length-1 && player[currentPlayer].gold >= itemInfo["vit"][player[currentPlayer].vitLvl+1].cost)
	  		{
	  			actionList.push({code:"buy", param1:"vit", param2:(player[currentPlayer].vitLvl+1)});
	  		}
	  		if (player[currentPlayer].defLvl<itemInfo["def"].length-1 && player[currentPlayer].gold >= itemInfo["def"][player[currentPlayer].defLvl+1].cost)
	  		{
	  			actionList.push({code:"buy", param1:"def", param2:(player[currentPlayer].defLvl+1)});
	  		}
	  		if (player[currentPlayer].atkLvl<itemInfo["atk"].length-1 && player[currentPlayer].gold >= itemInfo["atk"][player[currentPlayer].atkLvl+1].cost)
	  		{
	  			actionList.push({code:"buy", param1:"atk", param2:(player[currentPlayer].atkLvl+1)});
	  		}
	  		if (player[currentPlayer].enrLvl<itemInfo["enr"].length-1 && player[currentPlayer].gold >= itemInfo["enr"][player[currentPlayer].enrLvl+1].cost)
	  		{
	  			actionList.push({code:"buy", param1:"enr", param2:(player[currentPlayer].enrLvl+1)});
	  		}

			if (player[currentPlayer].gold >= itemInfo["pot"][0].cost)
	  		{
	  			actionList.push({code:"buy", param1:"pot", param2:0});
	  		}
	  		

	  	}

	  	return actionList;
	  }
		
		function executeAction(code, p1, p2)
		{
			var validAction=false;
			var actionList = getPossibleActions();
			for (a in actionList)
			{
				if (actionList[a].code=="mov" && actionList[a].param1==p1 && actionList[a].param2 == p2)
					validAction=true;

				if (actionList[a].code=="atk" && actionList[a].param1==p1)
					validAction=true;

				if (actionList[a].code=="battle" && actionList[a].param1==p1)
					validAction=true;

				if (actionList[a].code=="buy")
					validAction=true;

				if (actionList[a].code=="cancel")
					validAction=true;

				if (actionList[a].code=="end")
					validAction=true;
			}

			if (validAction==false)
			{
				console.log("Not a valid action: "+code+ " P1: "+p1+" P2: "+p2);
				return;
			}

			if (code=="mov")
			{
				player[currentPlayer].lane=p1;
				player[currentPlayer].box=p2;

				energy--;
			}

			if (code=="battle")
			{
				battleMonster.id=p1;
				switchPhase(phases.battle);
			}
			
			if (code=="end")
			{
				energy=0;
			}

			if (code=="atk")
			{
				p2=prompt("Damage");
				startAnimation("sword", battleMonster.x, battleMonster.y);



				var finalDmg=p2-monsters[p1].def;
				if (finalDmg<0) finalDmg=0;
				monsters[p1].hp-=finalDmg;
				dmgText.x=battleMonster.x-24;
				dmgText.y=battleMonster.y-battleMonster.h;
				dmgText.ttl=50;
				dmgText.text="-"+finalDmg;
				if (monsters[p1].hp<=0)
				{
					monsters[p1].alive=false;
					player[currentPlayer].gold+= 5 + (monsters[p1].lvl *2);
				}
				energy-=2;
				console.log("Attacking monster "+p1 +" Hp remaining: "+monsters[p1].hp+"  Alive: "+monsters[p1].alive);
			}

			if (code=="dmg")
			{
				var r = confirm("Hit player?");
				if (r == true) {
				    
				
				var mons = monsters[battleMonster.id];
				var finalDmg=(Math.floor((Math.random() * mons.atk) + 1))- itemInfo["def"][player[currentPlayer].defLvl].val;
				if (finalDmg<0) finalDmg=0;
				player[currentPlayer].hp-= finalDmg;
				dmgText.x=battlePlayer.x-24;
				dmgText.y=battlePlayer.y-battlePlayer.h;
				dmgText.ttl=50;
				dmgText.text="-"+finalDmg;
				console.log("Attacking player "+currentPlayer +" Damage: "+finalDmg+" Hp remaining: "+player[currentPlayer].hp);
				energy-=2;
				}
			}

			if (code=="buy")
			{
				var r = confirm("Comprar?");
				if (r == false) return;
				if (p1=="vit" && player[currentPlayer].gold >= itemInfo["vit"][player[currentPlayer].vitLvl+1].cost)
				{
					var hppercentage = player[currentPlayer].hp/itemInfo["vit"][player[currentPlayer].vitLvl].val;
					player[currentPlayer].gold-=itemInfo["vit"][player[currentPlayer].vitLvl+1].cost;
					player[currentPlayer].vitLvl++;
					player[currentPlayer].hp=Math.round(itemInfo["vit"][player[currentPlayer].vitLvl].val*hppercentage);

				}
				if (p1=="def" && player[currentPlayer].gold >= itemInfo["def"][player[currentPlayer].defLvl+1].cost)
				{
					player[currentPlayer].gold-=itemInfo["def"][player[currentPlayer].defLvl+1].cost;
					player[currentPlayer].defLvl++;

				}
				if (p1=="atk" && player[currentPlayer].gold >= itemInfo["atk"][player[currentPlayer].atkLvl+1].cost)
				{
					player[currentPlayer].gold-=itemInfo["atk"][player[currentPlayer].atkLvl+1].cost;
					player[currentPlayer].atkLvl++;

				}
				if (p1=="enr" && player[currentPlayer].gold >= itemInfo["enr"][player[currentPlayer].enrLvl+1].cost)
				{
					player[currentPlayer].gold-=itemInfo["enr"][player[currentPlayer].enrLvl+1].cost;
					player[currentPlayer].enrLvl++;

				}

				if (p1=="pot" && player[currentPlayer].gold >= itemInfo["pot"][0].cost)
				{
					player[currentPlayer].gold-=itemInfo["pot"][0].cost;
					player[currentPlayer].hp+=itemInfo["pot"][0].val;
					if (player[currentPlayer].hp>itemInfo["vit"][player[currentPlayer].vitLvl].val)
					{
						player[currentPlayer].hp=itemInfo["vit"][player[currentPlayer].vitLvl].val;
					}

				}
				energy--;

			}

			if (code=="cancel")
			{
				switchPhase(phases.playerActions);
			}

			if (energy<=0)
			{
				nextTurn();
			}
		}	 

		function nextTurn(){
				currentPlayer++;
				if (currentPlayer>=players)
					currentPlayer=0;
				switchPhase(phases.playerEnergy);
		}

		function getRandomInt(max)
		{
			return Math.floor((Math.random() * max) + 1);
		} 

		function click(x, y)
		{
			for (b in buttons)
			{
				if (x>buttons[b].x && x<buttons[b].x+buttons[b].w && y>buttons[b].y && y<buttons[b].y+buttons[b].h )
				{
					console.log("Clicked "+buttons[b].action+" "+buttons[b].p1+" "+buttons[b].p2);
					executeAction(buttons[b].action, buttons[b].p1, buttons[b].p2);
				}
			}

		}
	  

		//================  EVENTS  ======================

		//spawnMonster(0, 0);
	   var row=7;
	   var n=0;
		canvas.addEventListener('mousedown', function(evt) {
		var rect = canvas.getBoundingClientRect();
		console.log("board[\""+row+"."+n+"\"] = {x:" + Math.round(evt.clientX - rect.left)+ ", y:"+Math.round(evt.clientY-rect.top)+"}");
		n++;

		click(Math.round(evt.clientX - rect.left), Math.round(evt.clientY-rect.top));

		for (m in monsters)
		{
			console.log("Moving monster, hp"+monsters[m].hp);
			//if (monsters[m].box!=13)monsters[m].box--;
		}
      }, false);
      
    </script>
  </body>
</html>     

